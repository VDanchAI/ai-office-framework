# Иерархия документов

Этот документ объясняет, как документы структурированы, загружаются и взаимодействуют в фреймворке ИИ офиса. Сначала прочитайте [architecture.md](./architecture.md) для понимания системы на верхнем уровне.

---

## 1. Четыре типа документов

Каждый бот в системе использует комбинацию из до четырёх типов документов. У каждого типа — своя роль и область применения.

---

### Universal Core

**Паттерн имени файла:** `UNIVERSAL_CORE_v[X]_[Y].md`
**Шаблон:** `templates/TEMPLATE_CORE.md`

Universal Core — общий протокол, который загружается в каждый Claude Project, для каждого бота, без исключений. Он определяет, как боты думают и общаются, — а не что они знают и кем являются.

**Что содержит:**

| Секция | Назначение |
|---|---|
| Loading Order | Последовательность загрузки документов при старте сессии |
| Session Start | Обязательные действия в начале нового разговора |
| KB Navigation | Как использовать роутер для поиска и чтения секций KB |
| Core Protocols | Clarify, Think, Expert Mode, самопроверка, отслеживание контекста |
| Communication Rules | Тон, формат, структура ответа |
| Technical Operations | Работа с файлами, вывод кода, использование инструментов |
| Quality Protocol (D.A.O.S.) | Основной цикл контроля качества |

**Версионирование:** Один файл, поддерживается централизованно. Все боты используют одну версию. При обновлении Core все боты автоматически получают обновление — изменения на уровне отдельных ботов не нужны.

---

### База знаний (KB)

**Паттерн имени файла:** `[Role]_Knowledge_Base_v[X]_[Y].md`
**Шаблон:** `templates/TEMPLATE_KB.md`

KB содержит экспертизу по домену для конкретной роли. У каждого бота есть одна основная KB. Проектные KB можно добавлять, когда боту нужен контекст, ограниченный конкретным клиентом или проектом.

**Внутренняя структура:**

```
[Role]_Knowledge_Base_v[X]_[Y].md
│
├── Роутер (JSON-блок в начале файла)
│   └── Индекс всех секций с триггерами и якорями
│
└── Секции (markdown-контент под роутером)
    ├── #S1_TOPIC_NAME
    ├── #S2_TOPIC_NAME
    └── ...
```

Роутер всегда располагается в начале. Секции идут ниже — каждая идентифицируется уникальным якорем в формате `#S[number]_[TOPIC_NAME]`.

**Размеры KB в системе:**

| Бот | Размер KB |
|---|---|
| Аналитик | ~1 300 строк |
| Копирайтер | ~4 500 строк |
| Маркетолог | ~27 000 строк |

KB такого размера невозможно читать целиком при каждом запросе. Роутер существует именно для того, чтобы этого избежать — загружается только совпадающая секция.

**Типы роутеров** — подробности в Секции 4.

---

### Инструкции

**Паттерн имени файла:** `[Role]_Project_Instructions_v[X]_[Y].md`
**Шаблон:** `templates/TEMPLATE_INSTRUCTIONS.md`

Инструкции определяют, кто такой бот, что он делает и как себя ведёт. Это документ ролевого определения, загружаемый в поле «custom instructions» Claude Project.

**Стандартные секции:**

| Секция | Что определяет |
|---|---|
| Mandatory First Action | Что бот делает в первую очередь при старте сессии |
| Core Integration | Как найти и загрузить Universal Core и KB |
| Identity | Название роли, персона, голос |
| Scope | Что этот бот обрабатывает и что передаёт другим |
| Железные правила | Абсолютные ограничения, которые нельзя переопределить |
| Workflow | Пошаговый процесс для основных задач бота |
| Output Formats | Как структурируются и форматируются ответы |
| KB Usage | Когда и как обращаться к KB |
| Collaboration | Как этот бот взаимодействует с другими ботами в системе |

Инструкции каждого бота уникальны. Два бота могут использовать один Universal Core, но их инструкции всегда различаются.

---

### Аддоны

**Паттерн имени файла:** `[Addon_Name]_v[X]_[Y].md`
**Шаблон:** `templates/TEMPLATE_ADDON.md`

Аддоны расширяют экспертизу бота в конкретной области, не изменяя основную KB. Они опциональны, загружаются по требованию и могут использоваться несколькими ботами одновременно.

**Характеристики:**
- У каждого аддона есть свой мини-роутер и секции (та же структура, что у KB, но меньшего масштаба)
- Не загружаются постоянно — подключаются только когда задача требует их
- Могут принадлежать одному боту или быть общими для нескольких (например, модуль Brandbook Voice, используемый и Копирайтером, и Маркетологом)

**Примеры аддонов:**

| Аддон | Используется |
|---|---|
| Social Media Specs | Копирайтер, SMM-менеджер |
| Brandbook Voice | Копирайтер, Маркетолог, PR-бот |
| Platform Restrictions | Маркетолог, Ad Manager |

---

## 2. Порядок загрузки

Документы загружаются в фиксированной последовательности при старте каждой сессии. Этот порядок определён в Universal Core и не может быть изменён.

```
Старт сессии
│
├── Шаг 1: Universal Core          ← всегда первым, без исключений
│
├── Шаг 2: Инструкции              ← ролевая идентичность и правила поведения
│
├── Шаг 3: Только роутер KB        ← индекс, не контент
│
├── Шаг 4: Секция KB               ← только секция, совпадающая с запросом
│           (загружается под каждый запрос, не заранее)
│
└── Шаг 5: Аддоны                  ← только если задача требует их
            (загружаются под конкретную задачу, не постоянно)
```

**КЛЮЧЕВОЕ ПРАВИЛО: Никогда не загружать KB целиком.**

Роутер KB загружается один раз при старте сессии. Когда поступает запрос, бот сопоставляет его с триггерами роутера, определяет якорь нужной секции и читает только её. Остальная часть KB никогда не попадает в контекст.

Это не рекомендация — это жёсткое ограничение, закреплённое в Universal Core. Загрузка полной KB на больших файлах (например, 27 000 строк) исчерпает контекст и деградирует производительность.

---

## 3. Иерархия приоритетов

Когда документы противоречат друг другу — например, инструкции говорят одно, а Universal Core другое — приоритет определяет, что побеждает. Чем выше номер — тем выше приоритет.

| Приоритет | Тип документа / правила | Пример |
|---|---|---|
| 0 | Поведение Claude по умолчанию | Стандартные настройки общего ассистента |
| 1 | Аддоны | Правила форматирования для конкретной платформы |
| 2 | Контент KB | Доменные знания, фактический контент |
| 3 | Инструкции | Область роли, формат вывода, персона |
| 4 | Universal Core | Основные протоколы, D.A.O.S., правила сессии |
| 5 | Железные правила | Жёсткие ограничения, которые ничто не может переопределить |

**Разрешение конфликтов:** Когда два документа противоречат друг другу, побеждает тот, у которого выше номер приоритета. Без исключений.

Железные правила (приоритет 5) задаются в инструкциях как явные ограничения. Они переопределяют всё, включая Universal Core. Пример: «Никогда не генерировать контент на языке X» — это железное правило, оно сильнее любой инструкции из Core.

---

## 4. Роутер: детальный разбор

Роутер — это JSON-блок в начале каждого файла KB. Это навигационный индекс. Бот сначала читает роутер, находит нужную секцию, затем читает только её.

Существует два типа роутеров в зависимости от размера KB.

---

### Плоский роутер

Используется, когда в KB менее 20 секций.

**Структура:**

```json
{
  "router_version": "1.0",
  "router_type": "flat",
  "sections": [
    {
      "id": "S1",
      "title": "Audience Research Methods",
      "anchor": "#S1_AUDIENCE_RESEARCH",
      "triggers": ["audience", "research", "target", "segment", "persona"],
      "description": "Frameworks for defining and analyzing target audiences",
      "priority": "high"
    },
    {
      "id": "S2",
      "title": "Content Strategy",
      "anchor": "#S2_CONTENT_STRATEGY",
      "triggers": ["content", "strategy", "editorial", "calendar", "planning"],
      "description": "Content planning and editorial strategy frameworks",
      "priority": "medium"
    }
  ]
}
```

**Процесс поиска:**

```
Получен запрос
     │
     ▼
Сопоставить термины запроса с триггерами каждой секции
     │
     ▼
Определить лучшее совпадение → получить значение якоря
     │
     ▼
Перейти к этому якорю в теле KB
     │
     ▼
Прочитать контент секции
```

Каждая запись секции содержит:
- `id` — короткий идентификатор (S1, S2, ...)
- `title` — человекочитаемое название
- `anchor` — markdown-якорь для перехода (`#S1_AUDIENCE_RESEARCH`)
- `triggers` — ключевые слова, по которым выбирается эта секция
- `description` — однострочное описание содержимого секции
- `priority` — используется когда совпадают несколько секций (побеждает секция с более высоким приоритетом)

---

### Иерархический роутер

Используется когда в KB 20 и более секций. Плоский список на таком масштабе становится неудобным — качество сопоставления падает, и сам роутер становится достаточно большим, чтобы замедлить загрузку контекста.

Иерархический роутер вводит два уровня: мастер-роутер на уровне домена и суб-роутеры на уровне секций.

**Структура:**

```
Мастер-роутер (уровень домена)
├── Домен: Audience & Research
│   └── Суб-роутер → секции S1–S6
├── Домен: Content Strategy
│   └── Суб-роутер → секции S7–S14
├── Домен: Campaign Management
│   └── Суб-роутер → секции S15–S22
└── Домен: Analytics & Reporting
    └── Суб-роутер → секции S23–S28
```

**Двухэтапный поиск:**

```
Получен запрос
     │
     ▼
Этап 1: Сопоставить с триггерами доменов мастер-роутера
     │
     ▼
Определить домен → загрузить суб-роутер этого домена
     │
     ▼
Этап 2: Сопоставить с триггерами секций суб-роутера
     │
     ▼
Определить секцию → получить якорь
     │
     ▼
Перейти к якорю → прочитать секцию
```

**Запись мастер-роутера (пример):**

```json
{
  "id": "D3",
  "domain": "Campaign Management",
  "sub_router_anchor": "#SUBROUTER_CAMPAIGNS",
  "triggers": ["campaign", "launch", "budget", "ad", "promotion", "funnel"],
  "section_count": 8
}
```

**Запись суб-роутера (пример):**

```json
{
  "id": "S17",
  "title": "Budget Allocation Models",
  "anchor": "#S17_BUDGET_ALLOCATION",
  "triggers": ["budget", "allocate", "spend", "distribution", "CPL", "ROAS"],
  "description": "Models for distributing campaign budget across channels"
}
```

Суб-роутер хранится как секция внутри тела KB (со своим якорем), а не как отдельный файл. Это позволяет KB оставаться самодостаточной.

---

## 5. Версионирование

Все файлы используют двухчастный номер версии в имени файла.

**Формат:** `v[MAJOR]_[MINOR]`

| Часть версии | Когда увеличивается | Пример изменения |
|---|---|---|
| MAJOR | Структурные изменения | Добавлены или удалены секции, реорганизован роутер |
| MINOR | Изменения контента | Правки внутри существующих секций, новые примеры, исправления |

**Примеры:**
- `Marketer_Knowledge_Base_v3_0.md` → `v3_1.md` после добавления примеров в существующую секцию
- `Marketer_Knowledge_Base_v3_1.md` → `v4_0.md` после добавления трёх новых секций и реорганизации роутера

**Поведение бота:** Если существует несколько версий файла, бот автоматически выбирает наивысшую версию. Ручная фиксация версии не нужна.

**Версия роутера:** Роутер отслеживает собственную версию внутри JSON-блока (`"router_version": "1.2"`) — независимо от версии файла KB. Версия роутера увеличивается при изменении структуры роутера — добавлении новых секций в индекс, обновлении списков триггеров, изменении группировки по доменам — даже если контент тела KB не изменился.

---

## 6. Соглашение об именовании файлов

Все файлы следуют единому паттерну именования. Без пробелов — только подчёркивания.

```
Universal Core:
  UNIVERSAL_CORE_v[X]_[Y].md
  Пример: UNIVERSAL_CORE_v2_1.md

База знаний:
  [Role]_Knowledge_Base_v[X]_[Y].md
  Пример: Marketer_Knowledge_Base_v4_2.md
  Пример: Analyst_Knowledge_Base_v1_3.md

Инструкции:
  [Role]_Project_Instructions_v[X]_[Y].md
  Пример: Copywriter_Project_Instructions_v2_0.md

Аддоны:
  [Addon_Name]_v[X]_[Y].md
  Пример: Brandbook_Voice_v1_2.md
  Пример: Social_Media_Specs_v3_0.md
  Пример: Platform_Restrictions_v1_1.md
```

**Названия ролей** точно совпадают с ролью бота, определённой в системе — без сокращений и вариаций. Если бот называется «Copywriter» в системе, файл — `Copywriter_Knowledge_Base_v...`, а не `CW_KB_v...` или `Copy_KB_v...`.

---

## Обзор взаимодействия документов

```
┌─────────────────────────────────────────────────────────┐
│                    Claude Project                       │
│                                                         │
│  Custom Instructions:                                   │
│  ┌──────────────────────────────────────────────────┐  │
│  │  [Role]_Project_Instructions_v[X]_[Y].md         │  │
│  │  (загружается один раз, определяет идентичность  │  │
│  │   и поведение)                                   │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  Knowledge Sources:                                     │
│  ┌──────────────────┐  ┌──────────────────────────┐   │
│  │  UNIVERSAL_CORE  │  │  [Role]_Knowledge_Base   │   │
│  │  v[X]_[Y].md     │  │  v[X]_[Y].md             │   │
│  │                  │  │                           │   │
│  │  (всегда         │  │  Роутер → загружается     │   │
│  │   загружается)   │  │  при старте               │   │
│  │                  │  │  Секции → под запрос      │   │
│  └──────────────────┘  └──────────────────────────┘   │
│                                                         │
│  По требованию:                                         │
│  ┌──────────────────┐  ┌──────────────────────────┐   │
│  │  [Addon]         │  │  [Project_KB]            │   │
│  │  v[X]_[Y].md     │  │  v[X]_[Y].md             │   │
│  │  (под задачу)    │  │  (под проект/клиента)    │   │
│  └──────────────────┘  └──────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## Связанные документы

- [architecture.md](./architecture.md) — системный обзор, роли ботов, модель взаимодействия
- [roles-overview.md](./roles-overview.md) — описание ролей каждого бота
- [../templates/](../templates/) — шаблоны файлов для всех четырёх типов документов
